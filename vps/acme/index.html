<!doctype html>
<html>
    <head>
                <title>VPS|acme使用 - Ryan Simple Blog</title>

            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">

            
            <link rel="canonical" href="https://mming.github.io/vps/acme/">
            

            
                <link  rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
            
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                        <script>hljs.initHighlightingOnLoad();</script>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
            <link rel="stylesheet" href="../../assets/css/main.min.css">
                <script src="../../search/main.js"></script>

            
                
            
    </head>

    <body>
        <div class="container py-3">
            <header>
                    <!-- block header -->
<nav class="navbar navbar-expand-xl border-bottom">
    <div class="container-fluid">
        
            <img class="logo" src="../../assets/logo.png">
        

        
            <span class="normal fs-4 title-color site-name" id="component-site-name" style="text-transform: uppercase;">Ryan Simple Blog</span>
        

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
            aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
            <ul class="navbar-nav">

                <!-- block menu -->
                <li class="nav-item">
                    <!-- block menu -->
    
        <li class="nav-item" id="component-menu">
            <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[index]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../.." class="dropdown-item text-decoration-none ">首页</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../log/" class="dropdown-item text-decoration-none ">折腾log</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class=" active 
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Documents]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../python/mkdocs/" class="dropdown-item text-decoration-none ">python|about mkdocs</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../updateCentos7Git/" class="dropdown-item text-decoration-none ">VPS|升级centos7的git程序</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../tmuxCheatSheet/" class="dropdown-item text-decoration-none ">VPS|tmux快捷键</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="./" class="dropdown-item text-decoration-none  active ">VPS|acme使用</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../telegramBot/" class="dropdown-item text-decoration-none ">VPS|telegramBot</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../project/" class="dropdown-item text-decoration-none ">Project Manage|项目管理</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../projectManagement/scrcpy/" class="dropdown-item text-decoration-none ">Project Manage|手机投屏</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../projectManagement/varchar/" class="dropdown-item text-decoration-none ">Project Manage|字符与字节（mysql）</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../test/" class="dropdown-item text-decoration-none ">test2</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[About]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../about/" class="dropdown-item text-decoration-none ">关于Ta</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
            </ul>
        </li>
<!-- endblock -->
                </li>
                <!-- endblock -->

                <!-- block search -->
                <li class="nav-item">
                    <a class="collapsed" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                        <div class="md-search-icon">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </a>
                </li>
                <!--  endblock -->

                <!-- block source -->
                <li class="nav-item">
                    
                        
                            <!-- block source -->
<div class="md-source source-detail">
  <div class="md-source-repo-icon">
    <i class="fa fa-github-alt" aria-hidden="true"></i>
  </div>

  <div class="md-source-repo-url">
    <a href="https://github.com/mming/mming.github.io" class="md-source">
      mming/mming.github.io
    </a>

    <ul class="md-source-repo-text">
      <li>
        <i class="fa fa-tag" aria-hidden="true"></i>
        <img alt="GitHub tag (latest by date)"
          src="https://img.shields.io/github/v/tag/mming/mming.github.io?color=white&label=%20&style=flat-square">
      </li>

      <li>
        <i class="fa fa-star" aria-hidden="true"></i>
        <img alt="GitHub Repo stars"
          src="https://img.shields.io/github/stars/mming/mming.github.io?color=white&label=%20&style=flat-square">
      </li>

      <li>
        <i class="fa fa-code-fork" aria-hidden="true"></i>
        <img alt="GitHub forks"
          src="https://img.shields.io/github/forks/mming/mming.github.io?color=white&label=%20&style=flat-square">
      </li>
    </ul>
  </div>

</div>
<!--  endblock -->
                        
                    
                </li>
                <!--  endblock -->
            </ul>
        </div>
    </div>
</nav>
<!--  endblock -->
            </header>

            <main><!-- block search -->
<div class="collapse" id="collapseExample">
    <div role="search" class="search-box">
        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
            <input type="text" name="q" class="search-query"
            placeholder="Search docs" title="Type search term here" />
        </form>
    </div>
</div>
<!-- endblock -->
                    <!-- block content -->
<section class="container post">
    <article>
        <header>
            
                <h1 class="bold title" id="component-title">VPS|acme使用</h1>
            
        </header>
        <p><h1 id="acmesh">acme.sh使用</h1>
<p>环境：centos7</p>
<h2 id="acme">安装acme</h2>
<pre><code>wget -qO- get.acme.sh | bash 
source ~/.bashrc
cd ~/.acme.sh/
</code></pre>
<h3 id="_1">设置时区</h3>
<pre><code>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre>
<h3 id="_2">设置默认获取证书机构</h3>
<p>```python title='设置默认证书分发机构为letsencrypt.org'
acme.sh --set-default-ca --server letsencrypt</p>
<pre><code>
## dns方式获取证书
//
参考网址 https://github.com/acmesh-official/acme.sh/wiki/dnsapi
Using the global API key
First you need to login to your Cloudflare account to get your API key. Each token generated is not stored on cloudflare account and will have expiry if not set correctly. You will get this in API keys section.
https://dash.cloudflare.com/profile 
//

### 测试令牌是否可行
测试此令牌
要确认您的令牌是否工作正常，请复制下面的 CURL 命令并将其粘贴到终端 Shell 中进行测试。
</code></pre>
<p>curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
     -H "Authorization: Bearer 这里是你自己的值" \
     -H "Content-Type:application/json"</p>
<pre><code>上面第一步创建的令牌，即为token
CF_Token=&quot;这里是你自己的值“

分别获取账户ID和区域ID
CF_Account_ID=&quot;这里是你自己的值&quot;
CF_Zone_ID=&quot;这里是你自己的值&quot;   //此项非必须

```python title='终端输入命令'
export CF_Token=&quot;这里是你自己的值&quot;
export CF_Account_ID=&quot;这里是你自己的值&quot;
export CF_Zone_ID=&quot;这里是你自己的值&quot;
</code></pre>
<h3 id="ecc">申请证书 （用ecc模式吧</h3>
<pre><code>acme.sh --issue -d 这里是你的域名 -d 这里是你的域名2 --dns dns_cf -k ec-256
</code></pre>
<blockquote>
<p>关于定时任务：编辑当前用户的定时任务表: crontab -e
查看当前用户的定时任务: crontab -l</p>
</blockquote>
<h3 id="_3">安装证书</h3>
<p>/root/.acme.sh/acme.sh --installcert -d 这里是你的域名 -d 这里是你的域名 --fullchain-file /自定义路径/cert.crt --key-file /自定义路径/private.key --ecc</p>
<h3 id="crontabacme">设置crontab将acme自动续期的证书安装到自定义的目录里</h3>
<p>创建 renew.sh脚本，并使用crontab定时跑脚本
```python title='renew.sh'
/root/.acme.sh/acme.sh --installcert -d 这里是你的域名 -d 这里是你的域名 --fullchain-file /自定义路径/cert.crt --key-file /自定义路径/private.key --ecc
echo "Certificates Renewed"</p>
<p>chmod +r /自定义路径private.key
echo "Read Permission Granted for Private Key"</p>
<p>docker restart nginx
echo "nginx Restarted"</p>
<pre><code>
## docker安装
```python title='安装 Docker '
curl -fsSL https://get.docker.com | sh
or wget -qO- get.docker.com | bash
docker pull nginx

docker pull containrrr/watchtower
</code></pre>
<h3 id="200">每天凌晨2:00轮询检查更新</h3>
<pre><code>docker run -d \
    --name watchtower \
    --restart unless-stopped \
    -v /var/run/docker.sock:/var/run/docker.sock \
    containrrr/watchtower -c \
    --schedule &quot;0 0 2 * * *&quot;
</code></pre>
<h3 id="update">如果已经启动的项目，则使用update更新：</h3>
<pre><code>docker update --restart=always 【dockername】
</code></pre>
<hr />
<h2 id="_4">附录</h2>
<p>```手动更新证书：
acme.sh --renew -d example.com --force</p>
<pre><code>
```查看证书列表：
acme.sh --list
</code></pre>
<pre><code class="language-停止renew">acme.sh --remove -d example.com
</code></pre>
<p>常见问题
-bash: acme.sh: command not found
我暂时只遇到了该问题，解决办法是使用 acme 的绝对地址或者在acme.sh前加./
/root/.acme.sh/acme.sh  --issue  -d example.com  --dns dns_cf  -d <em>.example.com    #方法1
./acme.sh  --issue  -d example.com  --dns dns_cf  -d </em>.example.com                 #方法2</p>
<h2 id="2-firewall">附录2 firewall</h2>
<pre><code class="language-开启端口">[root@centos7 ~]# firewall-cmd --zone=public --add-port=80/tcp --permanent
</code></pre>
<p>```查询端口号80 是否开启：
[root@centos7 ~]# firewall-cmd --query-port=80/tcp</p>
<pre><code>
```重启防火墙：
[root@centos7 ~]# firewall-cmd --reload
</code></pre>
<p>```查询有哪些端口是开启的:
[root@centos7 ~]# firewall-cmd --list-port</p>
<pre><code>命令含义：
--zone #作用域
--add-port=80/tcp #添加端口，格式为：端口/通讯协议
--permanent #永久生效，没有此参数重启后失效

```关闭firewall：
systemctl stop firewalld.service #停止firewall

systemctl disable firewalld.service #禁止firewall开机启动
</code></pre></p>
    </article>
</section>
<!-- endblock -->
            </main>

            
                    <!-- block preview -->
        <div class="row row-cols-md-3 text-center pt-md-3" id="component-preview">
            <div class="col themed-grid-col">
                <a rel="prev" href="../tmuxCheatSheet/" class="nav-link">
                    <i class="fa fa-arrow-left"></i> Previous
                </a>
            </div>
            <div class="col themed-grid-col"></div>
            <div class="col themed-grid-col">
                <a rel="next" href="../telegramBot/" class="nav-link">
                    Next <i class="fa fa-arrow-right"></i>
                </a>
            </div>
        </div>
<!-- endblock -->
            

            
            
        </div>

            <script>var base_url = '../..';</script>
            <script src="../../assets/js/jquery-3.3.1.slim.min.js""></script>
            <script src="../../assets/js/bootstrap.bundle.min.js""></script>
            <script src="../../assets/js/main.min.js""></script>
                <script src="../../search/main.js" defer></script>

    </body>

</html>